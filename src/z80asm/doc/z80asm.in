# z80asm - Z80 module assembler, linker, librarian

**z80asm** is part of the [z88dk](http://www.z88dk.org/) project and is used as the back-end of the z88dk C compilers. It is not to be confused with other non-**z88dk** related projects with the same name.

**z80asm** is a relocatable assembler, linker and librarian that can assemble Intel 8080/8085 and Z80-family assembly files into a relocatable object format, can manage sets of object files in libraries and can build binary images by linking these object files together. The binary images can be defined in different sections, to match the target architecture.

**NOTE**: This document is a work-in-progress. It describes the functionality already working in the assembler in the **z80asm2** branch. This document and the `z80asm-future.md` will converge as **z80asm2** gets more features and converges to the current capability of **z80asm** in the **master** branch.

## Usage ...

### ... as assembler

    z80asm [options] file...

By default, i.e. without any options, assemble each of the listed files into relocatable object files with a `.o` extension. 

### ... as linker

    z80asm -b [options] [-ilibrary.lib...] file...

Link the object files together and with any requested libraries into a set of binary files.

### ... as librarian

    z80asm -xlibrary.lib [options] file...

Build a library containing all the object files passed as argument. That library can then be used during linking by specifying it with the `-i` option.

## Environment Variables

The syntax `${ENV_VAR}` can be used whenever a file name or a command line option is expected, and expands to the value of the given environment variable, or the empty string if it is not defined.

The environment variable `Z80ASM`, if defined, contains additional options that are used in every invocation of **z80asm**.

The environment variable `ZCCCFG` is used to search for the **z80asm** libraries at its parent directory, i.e. `${ZCCCFG}/..`. These libraries define emulation routines for certain opcodes not available in all platforms. 

**TODO**: table with all emulated opcodes.

## Options 

### Help Options

#### no arguments (show usage)

Show a help screen with the available options. 

#### -h, -?, --help (show manual)

Show this document. The output can be piped to `more` for pagination.

#### -v, --verbose (show progress)

Show progress messages on `stdout`.

### Environment Options

#### -IDIR, --inc-path=DIR (directory for source files)

Append the specified directory to the search path for source and include files.

While each source file is being assembled, its parent directory is automatically added to the search path, so that `INCLUDE` can refer to include files via a relative path to the source.

#### -LDIR, --lib-path=DIR (directory for library)

Append the specified directory to the search path for library files.

### -DVARIABLE [= value], --define=VARIABLE [= value] (define a static symbol)

Define the given variable as a static symbol with the given value, or 1 if not supplied.

The value can be written in decimal (e.g. -Dvar=255) or hexadecimal (e.g. -Dvar=0xff or -Dvar=0ffh or -Dvar=$ff). Note that the '$' may need to be escaped from the shell.

### Code Generation Options

#### -mCPU, --cpu=CPU (select CPU)

Assemble for the given CPU. The following CPU's are supported:

| CPU      | Name                          |
| -------- | ----------------------------- |
| z80      | Zilog Z80                     |
| z180     | Zilog Z180                    |
| z80n     | ZX Next variant of the Z80    |
| gbz80    | GameBoy variant of the Z80    |
| 8080     | Intel 8080 (1)                |
| 8085     | Intel 8085 (1)                |
| r2k      | Rabbit RCM2000                |
| r3k      | Rabbit RCM3000                |
| ti83     | Texas Instruments TI83 (2)    |
| ti83plus | Texas Instruments TI83Plus (2)|

**Notes:**

**(1)** The Intel 8080 and 8085 are with Zilog or Intel mnemonics, except for the mnemonics that have different meanings, i.e.

| Intel | Zilog      | Comment                                     |
| ----- | ---------- | ------------------------------------------- |
| JP nn | JP P, nn   | Must use Zilog mnemonic, as JP is ambiguous |
| CP nn | CALL P, nn | Must use Zilog mnemonic, as CP is ambiguous |

**(2)** The Texas Instruments CPU's are standard Z80, but the `INVOKE` statement is assembled differently, i.e.

| CPU      | Statement | Assembled as       |
| ----     | --------- | ------------------ |
| ti83     | INVOKE nn | CALL nn            |
| ti83plus | INVOKE nn | RST 0x28 \ DEFW nn |

#### -IXIY, --IXIY (swap IX and IY)

Swap all occurrences of registers `IX` and `IY`, and also their 8-bit halves (`IXH`, `IXL`, `IYH` and `IYL`).

#### --opt=speed (optimise for speed)

Replace all occurrences of `JR` by `JP`, as the later are faster. `DJNZ` is not replaced by `DEC B \ JP` as the later is slower.

#### --debug (debug information)

Add debug information to the map file: new symbols `__C_LINE_nn` and `__ASM_LINE_nn` are created on each `C_LINE` statement (supplied by the C compiler) and each asm line, and listed in the map file together with their source file location.

### Output File Options

#### -m, --map (create map file)

Creates a map file at the end of the link phase. The map file contains one line per defined symbol, with the following information:

  - symbol name
  - '='
  - aboslute address in the binary file in hexadecimal
  - ';'
  - 'const' if symbols is a constant, 'addr' if it is an address or 'comput' if it is an expression evaluated at link time
  - ','
  - scope of the symbol: 'local', 'public', 'extern' or 'global'
  - ','
  - 'def' if symbol is a global define (defined with `-Dsymbol` or `DEFINE`), empty string otherwise
  - ','
  - module name where symbol was defined
  - ','
  - section name where symbol was defined
  - ','
  - source file name where symbol was defined
  - ':'
  - source line number where symbol was defined
  





## Copyright

The original z80asm module assembler was written by Gunther Strube. 
It was converted from QL SuperBASIC version 0.956, initially ported to Lattice C,
and then to C68 on QDOS.

It has been maintained since 2011 by Paulo Custodio.

Copyright (C) Gunther Strube, InterLogic 1993-99  
Copyright (C) Paulo Custodio, 2011-2020

## License

Artistic License 2.0 (http://www.perlfoundation.org/artisticlicense2_0)
